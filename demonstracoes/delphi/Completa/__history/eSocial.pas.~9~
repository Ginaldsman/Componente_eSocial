unit eSocial;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, OleCtrls, StdCtrls, ESocialClientX_TLB;

type
  TExemplo = class(TForm)
    btnConfigurar: TButton;
    btnGerarXML: TButton;
    btnAssinar: TButton;
    btnEnviar: TButton;
    btnConsultar: TButton;
    cbbCertificados: TComboBox;
    edtIDLote: TEdit;
    mmXML: TMemo;
    spdESocialClientX1: TspdESocialClientX;
    Button1: TButton;
    Button2: TButton;
    procedure FormCreate(Sender: TObject);
    procedure btnConfigurarClick(Sender: TObject);
    procedure btnGerarXMLClick(Sender: TObject);
    procedure btnAssinarClick(Sender: TObject);
    procedure btnEnviarClick(Sender: TObject);
    procedure btnConsultarClick(Sender: TObject);
    procedure Button1Click(Sender: TObject);
    procedure Button2Click(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
    eSocial: TspdESocialClientX;
  end;

var
  Exemplo: TExemplo;

implementation

{$R *.dfm}

procedure TExemplo.btnAssinarClick(Sender: TObject);
begin

mmXML.Text := eSocial.AssinarEvento(mmXML.Text);

end;

procedure TExemplo.btnConfigurarClick(Sender: TObject);
begin

eSocial.CpfCnpjEmpregador := '08187168000160';
eSocial.CpfCnpjTransmissor := '08187168000160';
eSocial.VersaoManual := vm24;
eSocial.DiretorioTemplates := 'C:\Program Files\TecnoSpeed\eSocial\Arquivos\Templates\';
eSocial.DiretorioEsquemas := 'C:\Program Files\TecnoSpeed\eSocial\Arquivos\Esquemas\';
eSocial.Ambiente := akPreProducaoReais;
eSocial.ConfigurarSoftwareHouse('12090234903','GRk7PBfmzx5QaeJFHpMUI3GlyFaZIGDUQAkezoPb');
eSocial.NomeCertificado := cbbCertificados.Text;

mmXML.Lines.Text := 'Propriedades configuradas.';

end;

procedure TExemplo.btnConsultarClick(Sender: TObject);
var
_Lote: IspdRetConsultarLote;
_i, _j, _k: Integer;
begin

_Lote := eSocial.ConsultarLoteEventos(edtIDLote.Text);

mmXML.Lines.Clear;
mmXML.Lines.Add('Lote:');
mmXML.Lines.Add('    Número do Protocolo: ' + _Lote.NumeroProtocolo);
mmXML.Lines.Add('    Mensagem de Retorno: ' + _Lote.Mensagem);
mmXML.Lines.Add('    Status do Lote: ' + _Lote.Status);
mmXML.Lines.Add('    Tempo estimado para conclusão do processamento: ' + _Lote.TempoEstimadoConclusao + #13#10);

for _i := 0 to _Lote.Count - 1 do
begin

  mmXML.Lines.Add('Evento ' + IntToStr(_i+1) + ':');
  mmXML.Lines.Add('    Id Evento: ' + _Lote.Eventos[_i].IdEvento);
  mmXML.Lines.Add('    Número Recibo: ' + _Lote.Eventos[_i].NumeroRecibo);
  mmXML.Lines.Add('    Código de Status: ' + _Lote.Eventos[_i].cStat);
  mmXML.Lines.Add('    Mensagem: ' + _Lote.Eventos[_i].Mensagem);
  mmXML.Lines.Add('    Status do Evento: ' + _Lote.Eventos[_i].Status + #13#10);

for _j := 0 to _Lote.Eventos[_i].Count -1 do
begin

  mmXML.Lines.Add('    Ocorrencia ' + IntToStr(_j+1) + ':');
  mmXML.Lines.Add('    Código: ' + _Lote.Eventos[_i].Ocorrencias[_j].Codigo);
  mmXML.Lines.Add('    Descrição: ' + _Lote.Eventos[_i].Ocorrencias[_j].Descricao);
  mmXML.Lines.Add('    Tipo: ' + _Lote.Eventos[_i].Ocorrencias[_j].Tipo);
  mmXML.Lines.Add('    Localização: ' + _Lote.Eventos[_i].Ocorrencias[_j].Localizacao + #13#10);

end;

end;

for _k := 0 to _Lote.CountOcorrencias - 1 do
begin

  mmXML.Lines.Add('Lote:');
  mmXML.Lines.Add('    Codigo: ' + _Lote.Ocorrencias[_k].Codigo);
  mmXML.Lines.Add('    Tipo: ' + _Lote.Ocorrencias[_k].Tipo);
  mmXML.Lines.Add('    Localização: ' + _Lote.Ocorrencias[_k].Localizacao);
  mmXML.Lines.Add('    Descrição: ' + _Lote.Ocorrencias[_k].Descricao);

end;

mmXML.Lines.Add('XML: ' + #13#10 + '    ' + _Lote.XmlRetorno);

end;

procedure TExemplo.btnEnviarClick(Sender: TObject);
var
_Retorno: IspdRetEnviarLoteEventos;
begin

_Retorno := eSocial.EnviarLoteEventos(mmXML.Text, 1);
edtIDLote.Text := _Retorno.IdLote;

mmXML.Lines.Clear;
mmXML.Lines.Add('Retorno:');
mmXML.Lines.Add('    ID Lote: ' + _Retorno.IdLote);
mmXML.Lines.Add('    Mensagem: ' + _Retorno.Mensagem);

end;

procedure TExemplo.btnGerarXMLClick(Sender: TObject);
begin

mmXML.Text := eSocial.GerarXMLporTx2(mmXML.Text);

end;

procedure TExemplo.Button1Click(Sender: TObject);
begin

mmXML.Lines.Clear;

mmXML.Lines.Add('INCLUIRS1000');

mmXML.Lines.Add('tpAmb_4=' + '2');
mmXML.Lines.Add('procEmi_5=' + '1');
mmXML.Lines.Add('verProc_6=' + '1.0');
mmXML.Lines.Add('tpInsc_8=' + '1');
mmXML.Lines.Add('nrInsc_9=' + '08187168');
mmXML.Lines.Add('iniValid_13=' + '2017-07');
mmXML.Lines.Add('nmRazao_15=' + 'TECNOSPEED TECNOLOGIA DA INFORMACAO');
mmXML.Lines.Add('classTrib_16=' + '99');
mmXML.Lines.Add('natJurid_17=' + '2054');
mmXML.Lines.Add('indCoop_18=' + '0');
mmXML.Lines.Add('indConstr_19=' + '0');
mmXML.Lines.Add('indDesFolha_20=' + '0');
mmXML.Lines.Add('indOptRegEletron_21=' + '0');
mmXML.Lines.Add('indEntEd_23=' + 'N');
mmXML.Lines.Add('indEtt_24=' + 'N');
mmXML.Lines.Add('nmCtt_36=' + 'João da Silva');
mmXML.Lines.Add('cpfCtt_37=' + '12090234903');
mmXML.Lines.Add('foneCel_39=' + '7867834687');
mmXML.Lines.Add('foneFixo_38=' + '4430379500');
mmXML.Lines.Add('indSitPJ_63=' + '0');
mmXML.Lines.Add('INCLUIRSOFTWAREHOUSE_55');
mmXML.Lines.Add('cnpjSoftHouse_56=' + '13930441000134');
mmXML.Lines.Add('nmRazao_57=' + 'Empresa de Teste');
mmXML.Lines.Add('nmCont_58=' + 'Nome do Contato');
mmXML.Lines.Add('telefone_59=' + '4430303030');
mmXML.Lines.Add('SALVARSOFTWAREHOUSE_55');

mmXML.Lines.Add('SALVARS1000');

end;

procedure TExemplo.Button2Click(Sender: TObject);
begin

mmXML.Lines.Clear;

mmXML.Lines.Add('EXCLUIRS1000');

mmXML.Lines.Add('tpAmb_4=' + '2');
mmXML.Lines.Add('procEmi_5=' + '1');
mmXML.Lines.Add('verProc_6=' + '1.0');
mmXML.Lines.Add('tpInsc_8=' + '1');
mmXML.Lines.Add('nrInsc_9=' + '08187168');
mmXML.Lines.Add('iniValid_13=' + '2017-07');

mmXML.Lines.Add('SALVARS1000');

end;

procedure TExemplo.FormCreate(Sender: TObject);
begin

eSocial := TspdESocialClientX.Create(nil);

cbbCertificados.Items.Text := eSocial.ListarCertificados(#13#10);

end;

end.
